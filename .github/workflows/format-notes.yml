# Optional: Set permissions if you need to push changes back to the repository
# This is necessary if you want the workflow to commit the formatted files.
permissions:
  contents: write 

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      # Important: Fetch the full history so we can commit later
      fetch-depth: 0 

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20' # Use a recent, stable Node.js version

  # --- Step 1: Standard Prettier Formatting ---
  - name: Install Prettier and Plugins
    run: |
      # Install Prettier globally or locally. Installing globally is often simpler for GH Actions.
      npm install -g prettier@3.2.5 
      # Install the specific plugin to correctly handle YAML front matter (common in Obsidian)
      npm install -g prettier-plugin-markdown-with-frontmatter@1.0.0

  - name: Run Prettier Formatting
    id: format
    run: |
      # Finds all files ending with .md and pipes the list to Prettier.
      find . -name "*.md" -print0 | xargs -0 prettier --write --list-different
      
      # NOTE: If you prefer to only check for formatting issues without modifying the files, 
      # use 'prettier --check' instead of '--write --list-different'.
  
  # --- Step 2: LLM Emoji Formatting ---
  - name: Run LLM Emoji Heading Formatting
    # Execute the script from the correct path
    run: node .github/scripts/emoji_formatter.js
    env:
      # This environment variable provides the API key to the script.
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  # --- Step 3: Commit Changes ---
  - name: Commit and Push Changes (if any)
    # This step only runs if there were files modified by Prettier OR the LLM script
    if: success()
    run: |
      # Configure Git user for the commit
      git config user.name 'github-actions[bot]'
      git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      # Check for changes in the staging area and commit only if files were added/modified
      if git diff --exit-code --quiet; then
        echo "No formatting or emoji changes found. Exiting."
      else
        echo "Formatting and emoji changes found. Committing..."
        git add .
        git commit -m "ðŸ¤– Auto-Format: Cleaned up and added emojis to notes"
        
        # Use the token provided by GitHub Actions to push the commit
        git push
